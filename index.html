<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>v89.0 自动全屏沉浸版</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* 顶部状态栏 */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 30px;
            background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #888; z-index: 100;
            transition: opacity 0.5s;
        }
        
        /* 滚动容器 */
        #scroll-container {
            position: absolute; top: 30px; left: 0; width: 100%; 
            height: calc(100% - 130px); 
            overflow-y: scroll;
            scroll-behavior: auto; 
            transition: all 0.5s;
        }
        #scroll-container::-webkit-scrollbar { display: none; }

        #content {
            padding: 40vh 5% 800px 5%;
            width: 90%;
            font-size: 50px; 
            line-height: 1.6; 
            text-align: center;
        }
        
        .mirror-on { transform: scaleX(-1); }

        /* 底部控制区 */
        #bottom-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: #1a1a1a; border-top: 1px solid #333;
            display: flex; flex-direction: column; justify-content: space-evenly;
            z-index: 999; padding: 5px 15px; box-sizing: border-box;
            transition: all 0.5s;
        }

        .slider-row {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; color: #aaa; font-size: 12px;
        }
        .slider-row label { width: 40px; white-space: nowrap;}
        .slider-row input { flex: 1; margin: 0 10px; }
        .slider-val { width: 30px; text-align: right; color: #fff; }

        #btn-start {
            width: 100%; height: 35px;
            background: #0078d7; color: white; border: none; border-radius: 4px;
            font-weight: bold; font-size: 14px;
            margin-top: 5px; cursor: pointer;
        }
        .running #btn-start { background: #d9534f; }

        /* 音量条 */
        #vol-meter {
            position: absolute; bottom: 100px; left: 0; width: 100%; height: 4px;
            background: #333; transition: bottom 0.5s, opacity 0.5s;
        }
        #vol-bar {
            width: 0%; height: 100%; background: #00E5FF;
            transition: width 0.1s;
        }

        /* 侧边悬浮按钮 */
        #side-controls {
            position: fixed; bottom: 110px; right: 10px;
            display: flex; flex-direction: column; gap: 8px; z-index: 998;
            transition: opacity 0.5s;
        }
        .mini-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(50,50,50,0.8); border: 1px solid #666;
            color: #fff; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* ★★★ 横屏沉浸模式 (核心修改) ★★★ */
        @media (orientation: landscape) {
            /* 1. 隐藏多余元素 */
            #status-bar { display: none !important; }
            #side-controls { display: none !important; } /* 彻底隐藏侧边按钮，防止遮挡 */
            
            /* 2. 扩大显示区域 */
            #scroll-container { 
                top: 0; 
                height: 100%; /* 全屏显示 */
            }
            #content {
                font-size: 70px; /* 大字号 */
                padding: 10vh 5% 500px 5%;
            }

            /* 3. 底部控制栏：平时半透明，防遮挡，只有音量条可见 */
            #bottom-panel {
                height: 50px;
                flex-direction: row;
                align-items: center;
                gap: 15px;
                opacity: 0.1; /* 默认几乎透明 */
                background: rgba(0,0,0,0.8);
                border: none;
            }
            /* 触摸底部时显示控制栏 */
            #bottom-panel:active, #bottom-panel:hover { opacity: 1; }
            
            /* 启动按钮样式调整 */
            #btn-start { width: 80px; height: 35px; margin: 0; }
            .slider-row { width: 30%; }
            
            /* 音量条贴底 */
            #vol-meter { bottom: 0; height: 3px; z-index: 1000; opacity: 0.5; pointer-events: none;}
        }

        /* 编辑器 */
        #editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; flex-direction: column;
        }
        #editor-text {
            flex: 1; width: 100%; background: #111; color: #fff; border: none; padding: 15px; font-size: 18px;
        }
        .editor-header {
             height: 40px; background: #222; display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
        }
    </style>
</head>
<body>

    <div id="status-bar">v89.0 自动全屏沉浸版 (请在竖屏调好参数)</div>
    
    <div id="vol-meter"><div id="vol-bar"></div></div>

    <div id="scroll-container">
        <div id="content"></div>
    </div>

    <div id="side-controls">
        <button class="mini-btn" onclick="openEditor()">稿</button>
        <button class="mini-btn" onclick="toggleMirror()">镜</button>
        <button class="mini-btn" onclick="changeFontSize(5)">+</button>
        <button class="mini-btn" onclick="changeFontSize(-5)">-</button>
        <button class="mini-btn" onclick="reset()">重</button>
    </div>

    <div id="bottom-panel">
        <div class="slider-row">
            <label>速度</label>
            <input type="range" id="speed-slider" min="0.5" max="5.0" step="0.1" value="1.5" oninput="updateSpeed(this.value)">
            <span id="speed-val" class="slider-val">1.5</span>
        </div>
        <div class="slider-row">
            <label>灵敏</label>
            <input type="range" id="sens-slider" min="1" max="50" step="1" value="15" oninput="updateSens(this.value)">
            <span id="sens-val" class="slider-val">15</span>
        </div>
        <button id="btn-start" onclick="toggleAudio()">启动声控</button>
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <button onclick="closeEditor()" style="color:#fff;background:none;border:none;">取消</button>
            <span style="color:#888;">编辑文稿</span>
            <button onclick="saveEditor()" style="color:#00E5FF;background:none;border:none;">完成</button>
        </div>
        <textarea id="editor-text"></textarea>
    </div>

    <script>
        var rawText = `这是v89自动全屏版。
核心逻辑升级：
1. 竖屏模式：
   您可以在此时调整字号、镜像、
   和编辑文稿。侧边栏都在。
2. 横屏 + 启动：
   当您把手机横过来，
   并点击底部的【启动声控】时，
   系统会强制进入“全屏模式”。
   - 侧边栏会自动消失。
   - 顶部状态栏消失。
   - 底部控制栏变透明。
   - 浏览器地址栏消失。
   整个屏幕只剩下文字。
3. 如何停止：
   点击屏幕底部区域，
   唤出控制栏，点击停止即可。`;

        var isRunning = false;
        var audioContext = null;
        var analyser = null;
        var microphone = null;
        var scriptProcessor = null;
        
        var baseSpeed = 1.5;
        var sensitivity = 15; 
        var currentScrollSpeed = 0;
        var container = document.getElementById('scroll-container');

        function init() { render(); }

        function render() {
            document.getElementById('content').innerHTML = rawText.replace(/\n/g, '<br>');
        }

        async function toggleAudio() {
            if (isRunning) { stopAudio(); } else { await startAudio(); }
        }

        async function startAudio() {
            // ★★★ 核心修改：点击启动时，触发全屏 ★★★
            enterFullscreen();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                scriptProcessor.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    for (let i = 0; i < array.length; i++) values += array[i];
                    const average = values / array.length;

                    document.getElementById('vol-bar').style.width = (average * 2) + "%";

                    if (average > sensitivity) {
                        targetSpeed = baseSpeed;
                        document.getElementById('btn-start').innerText = "检测中...";
                    } else {
                        targetSpeed = 0;
                        document.getElementById('btn-start').innerText = "等待声音";
                    }

                    currentScrollSpeed += (targetSpeed - currentScrollSpeed) * 0.1;
                    if (currentScrollSpeed > 0.1) container.scrollTop += currentScrollSpeed;
                };

                isRunning = true;
                document.getElementById('btn-start').innerText = "停止";
                document.getElementById('bottom-panel').classList.add('running');
                enableNoSleep();

            } catch (e) {
                alert("无法启动 (检查HTTPS/麦克风权限): " + e);
            }
        }

        function stopAudio() {
            if (audioContext) audioContext.close();
            if (microphone) microphone.disconnect();
            if (scriptProcessor) scriptProcessor.disconnect();
            isRunning = false;
            document.getElementById('btn-start').innerText = "启动声控";
            document.getElementById('bottom-panel').classList.remove('running');
            document.getElementById('vol-bar').style.width = "0%";
            
            // 停止时，可以选择是否退出全屏，这里建议保持全屏，避免跳动
            // exitFullscreen(); 
        }

        // ★★★ 自动全屏逻辑 ★★★
        function enterFullscreen() {
            var elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => { console.log("全屏被拦截，可能需要手动点击"); });
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        }

        function enableNoSleep() {
            let video = document.createElement('video');
            video.setAttribute('playsinline', '');
            video.setAttribute('src', 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAQBAAAABAAAABgd1ZGl0YW1sPAAAAAA=');
            video.style.display = 'none';
            document.body.appendChild(video);
            video.play().catch(()=>{});
        }

        function updateSpeed(val) {
            baseSpeed = parseFloat(val);
            document.getElementById('speed-val').innerText = baseSpeed.toFixed(1);
        }
        function updateSens(val) {
            sensitivity = parseInt(val);
            document.getElementById('sens-val').innerText = val;
        }
        function changeFontSize(d) {
            var el = document.getElementById('content');
            var s = parseInt(window.getComputedStyle(el).fontSize);
            el.style.fontSize = (s + d) + "px";
        }
        function toggleMirror() { document.getElementById('content').classList.toggle("mirror-on"); }
        function openEditor() { document.getElementById('editor-text').value = rawText; document.getElementById('editor-overlay').style.display = 'flex'; }
        function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
        function saveEditor() { 
            var val = document.getElementById('editor-text').value; 
            if (val) { rawText = val; render(); closeEditor(); } 
        }
        function reset() { container.scrollTop = 0; }

        init();
    </script>
</body>
</html>