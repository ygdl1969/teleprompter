<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>v88.0 横屏沉浸版</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* 顶部状态栏 (横屏会自动隐藏) */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 30px;
            background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #888; z-index: 100;
        }
        
        /* 滚动容器 */
        #scroll-container {
            position: absolute; top: 30px; left: 0; width: 100%; 
            height: calc(100% - 130px); /* 默认竖屏高度 */
            overflow-y: scroll;
            scroll-behavior: auto; 
        }
        #scroll-container::-webkit-scrollbar { display: none; }

        #content {
            padding: 40vh 5% 800px 5%;
            width: 90%;
            font-size: 55px; 
            line-height: 1.6; 
            text-align: center;
        }
        
        .mirror-on { transform: scaleX(-1); }

        /* 底部控制区 (默认竖屏样式) */
        #bottom-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: #1a1a1a; border-top: 1px solid #333;
            display: flex; flex-direction: column; justify-content: space-evenly;
            z-index: 999; padding: 5px 15px; box-sizing: border-box;
            transition: all 0.3s;
        }

        .slider-row {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; color: #aaa; font-size: 12px;
        }
        .slider-row label { width: 40px; white-space: nowrap;}
        .slider-row input { flex: 1; margin: 0 10px; }
        .slider-val { width: 30px; text-align: right; color: #fff; }

        #btn-start {
            width: 100%; height: 35px;
            background: #0078d7; color: white; border: none; border-radius: 4px;
            font-weight: bold; font-size: 14px;
            margin-top: 5px; cursor: pointer;
        }
        .running #btn-start { background: #d9534f; }

        /* 音量条可视化 */
        #vol-meter {
            position: absolute; bottom: 100px; left: 0; width: 100%; height: 4px;
            background: #333; transition: bottom 0.3s;
        }
        #vol-bar {
            width: 0%; height: 100%; background: #00E5FF;
            transition: width 0.1s;
        }

        /* 侧边悬浮按钮 */
        #side-controls {
            position: fixed; bottom: 110px; right: 10px;
            display: flex; flex-direction: column; gap: 8px; z-index: 998;
            transition: opacity 0.3s;
        }
        .mini-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(50,50,50,0.8); border: 1px solid #666;
            color: #fff; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* ★★★ 横屏适配核心代码 (CSS Media Query) ★★★ */
        @media (orientation: landscape) {
            /* 1. 隐藏顶部状态栏，节省空间 */
            #status-bar { display: none; }
            
            /* 2. 调整滚动区域，占满屏幕大部分 */
            #scroll-container { 
                top: 0; 
                height: calc(100% - 50px); /* 底部留50px给控制条 */
            }
            #content {
                font-size: 70px; /* 横屏字号变大 */
                padding: 10vh 10% 500px 10%; /* 减少顶部留白 */
            }

            /* 3. 底部控制条变薄，横向排列 */
            #bottom-panel {
                height: 50px;
                flex-direction: row; /* 变成一行 */
                align-items: center;
                gap: 15px;
            }
            
            /* 4. 调整滑块样式以适应横排 */
            .slider-row { width: 35%; }
            #btn-start { width: 20%; height: 35px; margin-top: 0; }
            
            /* 5. 调整音量条位置 */
            #vol-meter { bottom: 50px; }

            /* 6. 横屏时隐藏侧边按钮 (或者可以设为半透明) 以防遮挡 */
            /* 如果您想保留，可以注释掉下面这行 */
            #side-controls { opacity: 0.3; } 
        }

        /* 编辑器 */
        #editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; flex-direction: column;
        }
        #editor-text {
            flex: 1; width: 100%; background: #111; color: #fff; border: none; padding: 15px; font-size: 18px;
        }
        .editor-header {
             height: 40px; background: #222; display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
        }
    </style>
</head>
<body>

    <div id="status-bar">v88.0 横屏沉浸版 (请旋转手机)</div>
    
    <div id="vol-meter"><div id="vol-bar"></div></div>

    <div id="scroll-container">
        <div id="content"></div>
    </div>

    <div id="side-controls">
        <button class="mini-btn" onclick="toggleFullscreen()">⛶</button> <button class="mini-btn" onclick="openEditor()">稿</button>
        <button class="mini-btn" onclick="toggleMirror()">镜</button>
        <button class="mini-btn" onclick="changeFontSize(5)">+</button>
        <button class="mini-btn" onclick="changeFontSize(-5)">-</button>
        <button class="mini-btn" onclick="reset()">重</button>
    </div>

    <div id="bottom-panel">
        <div class="slider-row">
            <label>速度</label>
            <input type="range" id="speed-slider" min="0.5" max="5.0" step="0.1" value="1.5" oninput="updateSpeed(this.value)">
            <span id="speed-val" class="slider-val">1.5</span>
        </div>
        <div class="slider-row">
            <label>灵敏</label>
            <input type="range" id="sens-slider" min="1" max="50" step="1" value="15" oninput="updateSens(this.value)">
            <span id="sens-val" class="slider-val">15</span>
        </div>
        <button id="btn-start" onclick="toggleAudio()">启动声控</button>
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <button onclick="closeEditor()" style="color:#fff;background:none;border:none;">取消</button>
            <span style="color:#888;">编辑文稿</span>
            <button onclick="saveEditor()" style="color:#00E5FF;background:none;border:none;">完成</button>
        </div>
        <textarea id="editor-text"></textarea>
    </div>

    <script>
        var rawText = `这是v88横屏沉浸版。
支持手机旋转自动适配。
使用技巧：
1. 竖屏时：
   适合单手操作和设置参数。
   可以先调好灵敏度和速度。
2. 横屏时：
   界面会自动变身。
   顶部栏隐藏，底部栏变薄。
   字号自动变大。
   获得最大阅读视野。
3. 沉浸模式：
   点击右侧第一个【⛶】按钮。
   可以隐藏浏览器地址栏，
   让屏幕完全变成提词器。
祝您录制顺利！`;

        var isRunning = false;
        var audioContext = null;
        var analyser = null;
        var microphone = null;
        var scriptProcessor = null;
        
        var baseSpeed = 1.5;
        var sensitivity = 15; 
        var currentScrollSpeed = 0;
        var container = document.getElementById('scroll-container');

        function init() { render(); }

        function render() {
            document.getElementById('content').innerHTML = rawText.replace(/\n/g, '<br>');
        }

        async function toggleAudio() {
            if (isRunning) { stopAudio(); } else { await startAudio(); }
        }

        async function startAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                scriptProcessor.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    for (let i = 0; i < array.length; i++) values += array[i];
                    const average = values / array.length;

                    document.getElementById('vol-bar').style.width = (average * 2) + "%";

                    if (average > sensitivity) {
                        targetSpeed = baseSpeed;
                        document.getElementById('btn-start').innerText = "检测中...";
                    } else {
                        targetSpeed = 0;
                        document.getElementById('btn-start').innerText = "等待声音";
                    }

                    currentScrollSpeed += (targetSpeed - currentScrollSpeed) * 0.1;
                    if (currentScrollSpeed > 0.1) container.scrollTop += currentScrollSpeed;
                };

                isRunning = true;
                // 横屏时按钮文字会自动缩短，防止撑破布局
                document.getElementById('btn-start').innerText = "停止";
                document.getElementById('bottom-panel').classList.add('running');
                enableNoSleep();

            } catch (e) {
                alert("无法启动麦克风 (请检查HTTPS权限): " + e);
            }
        }

        function stopAudio() {
            if (audioContext) audioContext.close();
            if (microphone) microphone.disconnect();
            if (scriptProcessor) scriptProcessor.disconnect();
            isRunning = false;
            document.getElementById('btn-start').innerText = "启动声控";
            document.getElementById('bottom-panel').classList.remove('running');
            document.getElementById('vol-bar').style.width = "0%";
        }

        function enableNoSleep() {
            let video = document.createElement('video');
            video.setAttribute('playsinline', '');
            video.setAttribute('src', 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAQBAAAABAAAABgd1ZGl0YW1sPAAAAAA=');
            video.style.display = 'none';
            document.body.appendChild(video);
            video.play().catch(()=>{});
        }

        function updateSpeed(val) {
            baseSpeed = parseFloat(val);
            document.getElementById('speed-val').innerText = baseSpeed.toFixed(1);
        }
        function updateSens(val) {
            sensitivity = parseInt(val);
            document.getElementById('sens-val').innerText = val;
        }
        function changeFontSize(d) {
            var el = document.getElementById('content');
            var s = parseInt(window.getComputedStyle(el).fontSize);
            el.style.fontSize = (s + d) + "px";
        }
        function toggleMirror() { document.getElementById('content').classList.toggle("mirror-on"); }
        function openEditor() { document.getElementById('editor-text').value = rawText; document.getElementById('editor-overlay').style.display = 'flex'; }
        function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
        function saveEditor() { 
            var val = document.getElementById('editor-text').value; 
            if (val) { rawText = val; render(); closeEditor(); } 
        }
        function reset() { container.scrollTop = 0; }
        
        // ★★★ 全屏功能 ★★★
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        init();
    </script>
</body>
</html>