<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>v84.0 å®‰å“é€‚é…ç‰ˆ (v69å†…æ ¸)</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* å®‰å“å»é™¤ç‚¹å‡»é«˜å…‰ */
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 40px;
            background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #888; z-index: 100;
        }
        .status-wait { color: #FFA500 !important; font-weight: bold; }
        .status-running { color: #00E5FF !important; font-weight: bold; }
        .status-error { color: #ff4444 !important; font-weight: bold; }

        /* æ»šåŠ¨å®¹å™¨ */
        #scroll-container {
            position: absolute; top: 40px; left: 0; width: 100%; height: calc(100% - 110px);
            overflow-y: scroll;
            scroll-behavior: auto; 
        }
        #scroll-container::-webkit-scrollbar { display: none; }

        /* å†…å®¹åŒºåŸŸ - æ‰‹æœºç«¯å­—å·é€‚é… */
        #content {
            padding: 40vh 5% 800px 5%;
            width: 90%;
            font-size: 60px; /* æ‰‹æœºé»˜è®¤å­—å·ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹é€‚é…å±å¹• */
            line-height: 1.6; 
            text-align: center;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        .mirror-on { transform: scaleX(-1); }

        /* æ–‡å­—æ ·å¼ (v69) */
        .word {
            display: inline-block;
            color: #444; 
            margin: 0 2px;
            transition: color 0.5s; 
        }

        .active-word {
            color: #fff;
            text-shadow: 0 0 20px #00E5FF;
            transform: scale(1.1);
            font-weight: bold;
        }
        
        .passed-word { color: #222; }

        /* åº•éƒ¨æ§åˆ¶å° - é€‚é…æ‰‹æœºè§¦æ‘¸ */
        #controls {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: rgba(20, 20, 20, 0.95);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 999; border-top: 1px solid #333;
        }

        button, select {
            background: #222; color: #ccc; border: 1px solid #444;
            padding: 8px 10px; font-size: 14px; border-radius: 6px;
            font-weight: bold; outline: none;
        }
        /* æ‰‹æœºä¸ŠæŒ‰é’®æŒ‰ä¸‹å»çš„æ•ˆæœ */
        button:active, select:active { background: #444; color: #fff; }
        
        .btn-main { background: #0078d7; border-color: #0078d7; color: #fff; padding: 8px 20px; }
        .btn-stop { background: #d9534f; border-color: #d9534f; color: #fff; padding: 8px 20px; }
        .btn-wait { background: #FFA500; border-color: #FFA500; color: #000; padding: 8px 20px;}
        .btn-edit { border: 1px solid #00E5FF; color: #00E5FF; }

        #speed-meter {
            position: fixed; top: 50px; right: 20px;
            color: rgba(255,255,255,0.3); font-family: monospace; font-size: 12px; pointer-events: none;
        }

        /* â˜…â˜…â˜… å…¨å±ç¼–è¾‘å™¨ (é€‚é…æ‰‹æœº) â˜…â˜…â˜… */
        #editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            flex-direction: column;
        }
        .editor-header {
            height: 50px; background: #111; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333;
        }
        #editor-text {
            flex: 1; width: 100%; background: #111; color: #fff;
            border: none; padding: 15px; font-size: 18px; line-height: 1.5;
            font-family: sans-serif; resize: none; outline: none;
            box-sizing: border-box;
        }
        /* æ‰‹æœºè¾“å…¥æ³•å¼¹èµ·ä¼˜åŒ– */
        #editor-text:focus { background: #000; }
    </style>
</head>
<body>

    <div id="status-bar">v84.0 å®‰å“ç‰ˆ (å»ºè®®ä½¿ç”¨ HTTPS)</div>
    <div id="speed-meter">Flow: 0.0</div>

    <div id="scroll-container">
        <div id="content"></div>
    </div>

    <div id="controls">
        <button id="btn-mic" class="btn-main" onclick="toggleApp()">ğŸŒŠ å¯åŠ¨</button>
        
        <select id="font-selector" onchange="changeFontFamily(this.value)">
            <option value="'Microsoft YaHei', sans-serif">é»˜è®¤</option>
            <option value="'SimHei', sans-serif">ç²—ä½“</option>
            <option value="'KaiTi', serif">æ¥·ä½“</option>
            <option value="'SimSun', serif">å®‹ä½“</option>
        </select>

        <button onclick="changeFontSize(5)">A+</button>
        <button onclick="changeFontSize(-5)">A-</button>
        <button onclick="toggleMirror()">é•œåƒ</button>
        <button onclick="openEditor()" class="btn-edit">æ¢ç¨¿</button>
        <button onclick="reset()">é‡ç½®</button>
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <button class="btn-stop" onclick="closeEditor()" style="padding: 5px 15px;">å–æ¶ˆ</button>
            <span style="color:#888; font-weight:bold;">ç¼–è¾‘æ–‡ç¨¿</span>
            <button class="btn-main" onclick="saveEditor()" style="padding: 5px 15px;">å®Œæˆ</button>
        </div>
        <textarea id="editor-text" placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„æ–‡ç¨¿..."></textarea>
    </div>

    <script>
        var rawText = `è¿™æ˜¯v84å®‰å“é€‚é…ç‰ˆã€‚
é’ˆå¯¹å®‰å“æ‰‹æœºéº¦å…‹é£é—®é¢˜è¯´æ˜ï¼š
å®‰å“Chromeä¸ºäº†å®‰å…¨ï¼Œ
ç¦æ­¢æœ¬åœ°æ–‡ä»¶(file://)è°ƒç”¨éº¦å…‹é£ã€‚
å³ä½¿æ‚¨ç»™äº†æµè§ˆå™¨æƒé™ä¹Ÿä¸è¡Œã€‚
å¿…é¡»å°†æ­¤ç½‘é¡µæ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œ
å¹¶ä½¿ç”¨ HTTPS åè®®è®¿é—®ã€‚
æˆ–è€…åœ¨ç”µè„‘å¼€å¯å±€åŸŸç½‘æœåŠ¡ï¼Œ
æ‰‹æœºé€šè¿‡ http://192.168... è®¿é—®ã€‚
é™¤æ­¤ä¹‹å¤–ï¼Œ
æ­¤ç‰ˆæœ¬å†…æ ¸å®Œå…¨å¤åˆ»v69ã€‚
å¹¶æœªä¿®æ”¹ä»»ä½•ç‰©ç†å‚æ•°ã€‚
è¯·å°è¯•ç‚¹å‡»å¯åŠ¨ã€‚`;

        var words = [];
        var currIdx = 0;
        var recognition = null;
        var isRunning = false;
        
        // â˜…â˜…â˜… v69 æ ¸å¿ƒå‚æ•° (ä¸¥æ ¼ä¿æŒ) â˜…â˜…â˜…
        var currentSpeed = 0;    
        var minSpeed = 0.5;      
        var cruiseSpeed = 1.5;   
        var container = document.getElementById('scroll-container');
        var rafId = null;

        function init() { 
            render(); 
            checkProtocol(); // æ£€æµ‹æ˜¯å¦åœ¨æ‰‹æœºæœ¬åœ°è¿è¡Œ
        }

        // æ£€æµ‹åè®®
        function checkProtocol() {
            var protocol = window.location.protocol;
            if (protocol === 'file:' && /Android/i.test(navigator.userAgent)) {
                alert("âš ï¸ å®‰å“ç³»ç»Ÿè­¦å‘Šï¼š\n\næ‚¨æ­£åœ¨ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶ã€‚\nå®‰å“ Chrome ç¦æ­¢æ­¤ç±»æ–‡ä»¶ä½¿ç”¨éº¦å…‹é£ã€‚\n\nè¯·å°†æ­¤æ–‡ä»¶éƒ¨ç½²åˆ° Web æœåŠ¡å™¨(HTTPS)ï¼Œæˆ–ä½¿ç”¨ç”µè„‘å¼€å¯æœåŠ¡å™¨ä¾›æ‰‹æœºè®¿é—®ã€‚");
            }
        }

        function render() {
            var html = "";
            var idx = 0;
            for (let char of rawText) {
                if (char === '\n') html += '<br>';
                else if (char.trim() !== '') {
                    html += `<span class="word" id="w-${idx}">${char}</span>`;
                    idx++;
                }
            }
            document.getElementById('content').innerHTML = html;
            words = document.querySelectorAll('.word');
            currIdx = 0;
        }

        // --- ç¼–è¾‘å™¨é€»è¾‘ ---
        function openEditor() {
            document.getElementById('editor-text').value = rawText;
            document.getElementById('editor-overlay').style.display = 'flex';
        }

        function closeEditor() {
            document.getElementById('editor-overlay').style.display = 'none';
        }

        function saveEditor() {
            var val = document.getElementById('editor-text').value;
            if (val && val.trim().length > 0) {
                rawText = val;
                render();
                reset();
                closeEditor();
            }
        }

        // --- é€»è¾‘æ§åˆ¶ (v69) ---
        function toggleApp() {
            if (isRunning) stopApp();
            else prepareApp();
        }

        function prepareApp() {
            document.getElementById('btn-mic').innerText = "â³ å…è®¸...";
            document.getElementById('btn-mic').className = "btn-wait";
            document.getElementById('status-bar').innerText = "âš ï¸ è¯·ç‚¹å‡»æµè§ˆå™¨çš„â€œå…è®¸â€æŒ‰é’®...";
            document.getElementById('status-bar').className = "status-wait";
            startRecognition(); 
        }

        function startFlowing() {
            if (isRunning) return; 
            isRunning = true;
            document.getElementById('btn-mic').innerText = "ğŸ›‘ åœæ­¢";
            document.getElementById('btn-mic').className = "btn-stop";
            document.getElementById('status-bar').innerText = "ğŸŸ¢ æ­£åœ¨å¬... (v69å†…æ ¸)";
            document.getElementById('status-bar').className = "status-running";
            
            currentSpeed = minSpeed;
            startFlowEngine(); 
        }

        function stopApp() {
            isRunning = false;
            if(recognition) recognition.stop();
            cancelAnimationFrame(rafId);
            document.getElementById('btn-mic').innerText = "ğŸŒŠ å¯åŠ¨";
            document.getElementById('btn-mic').className = "btn-main";
            document.getElementById('status-bar').innerText = "å·²åœæ­¢";
            document.getElementById('status-bar').className = "";
            currentSpeed = 0; 
        }

        function startRecognition() {
            // å…¼å®¹å‰ç¼€
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«"); return; }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true; 
            recognition.maxAlternatives = 1;

            recognition.onstart = function() { startFlowing(); };

            recognition.onerror = function(event) {
                if (event.error === 'not-allowed') {
                    document.getElementById('status-bar').innerText = "âŒ éº¦å…‹é£è¢«æ‹’ç» (è¯·æ£€æŸ¥HTTPS)";
                    document.getElementById('status-bar').className = "status-error";
                    document.getElementById('btn-mic').innerText = "ğŸŒŠ å¯åŠ¨";
                    document.getElementById('btn-mic').className = "btn-main";
                    alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼\n\nå¦‚æœè¿™æ˜¯å®‰å“æ‰‹æœºï¼Œè¯·ç¡®ä¿æ‚¨æ˜¯é€šè¿‡ HTTPS ç½‘å€è®¿é—®çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰“å¼€çš„æ–‡ä»¶ã€‚");
                } else {
                     document.getElementById('status-bar').innerText = "âŒ é”™è¯¯: " + event.error;
                }
            };

            recognition.onresult = function(event) {
                var transcript = "";
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                smartMatch(transcript);
            };

            recognition.onend = function() {
                if (isRunning) try { recognition.start(); } catch(e){}
            };

            try { recognition.start(); } catch(e){}
        }

        // --- æµé€Ÿå¼•æ“ (v69 åŸç‰ˆ) ---
        function startFlowEngine() {
            function loop() {
                if (!isRunning) return;

                var activeEl = words[currIdx];
                var targetSpeed = 0;

                if (activeEl) {
                    var relativeY = activeEl.getBoundingClientRect().top;
                    // æ³¨æ„ï¼šæ‰‹æœºä¸Šæœ‰çŠ¶æ€æ ï¼Œviewporté«˜åº¦è¦åŠ¨æ€è·å–
                    var viewportH = window.innerHeight;
                    // v84ä¿®æ­£ï¼šé¡¶éƒ¨æœ‰40pxçŠ¶æ€æ ï¼Œè®¡ç®—æ¯”ä¾‹æ—¶è¦å‡å»åå·®ï¼Œä½†æ ¸å¿ƒé€»è¾‘ç»´æŒ v69
                    var ratio = relativeY / viewportH;

                    // v69 åŸå§‹åŠ¨æ€å¹³è¡¡é€»è¾‘
                    if (ratio > 0.50) { 
                        targetSpeed = cruiseSpeed + ((ratio - 0.50) * 15); 
                        if(targetSpeed > 15) targetSpeed = 15;
                    } 
                    else if (ratio < 0.35) { 
                        targetSpeed = minSpeed;
                        if (ratio < 0.15) targetSpeed = 0; 
                    } 
                    else { 
                        targetSpeed = cruiseSpeed;
                    }
                } else {
                    targetSpeed = 0;
                }

                currentSpeed += (targetSpeed - currentSpeed) * 0.05;
                
                container.scrollTop += currentSpeed;
                document.getElementById('speed-meter').innerText = "Flow: " + currentSpeed.toFixed(2);
                rafId = requestAnimationFrame(loop);
            }
            loop();
        }

        // --- æ™ºèƒ½é˜²è·³ (v69 åŸç‰ˆ) ---
        function smartMatch(transcript) {
            var clean = transcript.replace(/[^\u4e00-\u9fa50-9]/g, "");
            if (clean.length < 1) return;

            var foundOffset = -1;
            
            if (clean.length >= 2) {
                var key2 = clean.slice(-2);
                var searchWide = 50;
                for (let offset = 0; offset < searchWide; offset++) {
                    if (!words[currIdx + offset] || !words[currIdx + offset + 1]) break;
                    var char1 = words[currIdx + offset].innerText;
                    var char2 = words[currIdx + offset + 1].innerText;
                    if ((char1 + char2) === key2) {
                        foundOffset = offset + 1;
                        break; 
                    }
                }
            }

            if (foundOffset === -1) {
                var key1 = clean.slice(-1);
                var searchNarrow = 8; 
                for (let offset = 0; offset < searchNarrow; offset++) {
                    if (!words[currIdx + offset]) break;
                    if (words[currIdx + offset].innerText === key1) {
                        foundOffset = offset;
                        break; 
                    }
                }
            }

            if (foundOffset !== -1) {
                var newIdx = currIdx + foundOffset;
                for (let i = currIdx; i <= newIdx; i++) {
                     if(words[i]) {
                         words[i].className = (i < newIdx) ? "word passed-word" : "word active-word";
                     }
                }
                currIdx = newIdx;
            }
        }

        // --- UI åŠŸèƒ½ ---
        function changeFontSize(d) {
            var el = document.getElementById('content');
            var s = parseInt(window.getComputedStyle(el).fontSize);
            el.style.fontSize = (s + d) + "px";
        }
        
        function changeFontFamily(font) {
            document.getElementById('content').style.fontFamily = font;
        }

        function toggleMirror() { document.getElementById('content').classList.toggle("mirror-on"); }
        
        function reset() { 
            currIdx = 0; 
            render(); 
            container.scrollTop = 0; 
            if(isRunning) currentSpeed = minSpeed;
        }

        init();
    </script>
</body>
</html>