<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>v85.0 è¾“å…¥æ³•æ¥ç®¡ç‰ˆ</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 40px;
            background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #888; z-index: 100;
        }
        .status-ready { color: #00E5FF !important; font-weight: bold; }

        /* æ»šåŠ¨å®¹å™¨ */
        #scroll-container {
            position: absolute; top: 40px; left: 0; width: 100%; 
            /* ç•™å‡ºåº•éƒ¨ç©ºé—´ç»™é”®ç›˜ */
            height: calc(100% - 100px); 
            overflow-y: scroll;
            scroll-behavior: auto; 
        }
        #scroll-container::-webkit-scrollbar { display: none; }

        #content {
            padding: 40vh 5% 800px 5%;
            width: 90%;
            font-size: 50px; /* æ‰‹æœºé€‚ä¸­å­—å· */
            line-height: 1.6; 
            text-align: center;
        }
        
        .mirror-on { transform: scaleX(-1); }

        .word {
            display: inline-block;
            color: #444; 
            margin: 0 2px;
            transition: color 0.3s; 
        }

        .active-word {
            color: #fff;
            text-shadow: 0 0 20px #00E5FF;
            transform: scale(1.15);
            font-weight: bold;
        }
        
        .passed-word { color: #222; }

        /* â˜…â˜…â˜… éšå½¢è¾“å…¥è§¦å‘åŒº â˜…â˜…â˜… */
        #input-trigger {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #222; border-top: 1px solid #444;
            display: flex; align-items: center; justify-content: center;
            z-index: 999;
        }
        
        #hidden-input {
            width: 90%; height: 40px;
            background: #333; color: #fff;
            border: 1px solid #555; border-radius: 20px;
            padding: 0 15px; font-size: 16px;
            outline: none; text-align: center;
        }
        #hidden-input::placeholder { color: #888; }

        /* æ§åˆ¶æ  (æ‚¬æµ®åœ¨è¾“å…¥æ¡†ä¸Šæ–¹) */
        #controls {
            position: fixed; bottom: 70px; right: 10px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 998;
        }

        .mini-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(50,50,50,0.8); border: 1px solid #666;
            color: #fff; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .mini-btn:active { background: #0078d7; }

        /* ç¼–è¾‘å™¨ */
        #editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; flex-direction: column;
        }
        .editor-header {
            height: 50px; background: #111; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333;
        }
        #editor-text {
            flex: 1; width: 100%; background: #111; color: #fff; border: none; padding: 15px; font-size: 18px; line-height: 1.5; resize: none; outline: none;
        }
    </style>
</head>
<body>

    <div id="status-bar" class="status-ready">v85.0 è¾“å…¥æ³•æ¥ç®¡ç‰ˆ (è¯·ç‚¹ä¸‹æ–¹è¾“å…¥æ¡†)</div>
    
    <div id="scroll-container">
        <div id="content"></div>
    </div>

    <div id="controls">
        <button class="mini-btn" onclick="openEditor()">æ¢ç¨¿</button>
        <button class="mini-btn" onclick="toggleMirror()">é•œåƒ</button>
        <button class="mini-btn" onclick="changeFontSize(5)">A+</button>
        <button class="mini-btn" onclick="changeFontSize(-5)">A-</button>
        <button class="mini-btn" onclick="reset()">é‡ç½®</button>
    </div>

    <div id="input-trigger">
        <input type="text" id="hidden-input" placeholder="ç‚¹å‡»æ­¤å¤„ -> å¼€å¯é”®ç›˜è¯­éŸ³" autocomplete="off">
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <button onclick="closeEditor()" style="background:#d9534f;color:white;border:none;padding:5px 15px;border-radius:4px;">å–æ¶ˆ</button>
            <span style="color:#fff;">ç¼–è¾‘æ–‡ç¨¿</span>
            <button onclick="saveEditor()" style="background:#0078d7;color:white;border:none;padding:5px 15px;border-radius:4px;">å®Œæˆ</button>
        </div>
        <textarea id="editor-text"></textarea>
    </div>

    <script>
        var rawText = `è¿™æ˜¯v85è¾“å…¥æ³•æ¥ç®¡ç‰ˆã€‚
è§£å†³å›½å†…å®‰å“Chromeæ— æ³•è¯†åˆ«çš„é—®é¢˜ã€‚
ä½¿ç”¨æ–¹æ³•ï¼š
1. ç‚¹å‡»åº•éƒ¨çš„è¾“å…¥æ¡†ã€‚
2. æ‰‹æœºé”®ç›˜å¼¹å‡ºåï¼Œç‚¹å‡»é”®ç›˜ä¸Šçš„â€œéº¦å…‹é£â€å›¾æ ‡ã€‚
3. å¯¹ç€è¾“å…¥æ³•è¯´è¯ã€‚
4. è¾“å…¥æ³•ä¸Šå±çš„å­—ï¼Œä¼šç«‹åˆ»é©±åŠ¨æè¯å™¨æ»šåŠ¨ã€‚
æ­¤æ–¹æ¡ˆåˆ©ç”¨äº†æœç‹—/ç™¾åº¦/è®¯é£çš„å¼ºå¤§è¯†åˆ«èƒ½åŠ›ã€‚
è¯†åˆ«å‡†ã€é€Ÿåº¦å¿«ã€æ— è§†ç½‘ç»œé™åˆ¶ã€‚
è¯·å°½æƒ…å°è¯•ã€‚`;

        var words = [];
        var currIdx = 0;
        var container = document.getElementById('scroll-container');
        
        // v69 ç‰©ç†å‚æ•°
        var currentSpeed = 0;    
        var minSpeed = 0.5;      
        var cruiseSpeed = 1.5;   
        var rafId = null;
        var isRunning = true; // é»˜è®¤å¼€å¯ç‰©ç†å¼•æ“

        function init() { render(); startFlowEngine(); setupInputListener(); }

        function render() {
            var html = "";
            var idx = 0;
            for (let char of rawText) {
                if (char === '\n') html += '<br>';
                else if (char.trim() !== '') {
                    html += `<span class="word" id="w-${idx}">${char}</span>`;
                    idx++;
                }
            }
            document.getElementById('content').innerHTML = html;
            words = document.querySelectorAll('.word');
            currIdx = 0;
        }

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šç›‘å¬è¾“å…¥æ¡† â˜…â˜…â˜…
        function setupInputListener() {
            var input = document.getElementById('hidden-input');
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶
            input.addEventListener('input', function(e) {
                var text = e.target.value;
                if (text.length > 0) {
                    smartMatch(text);
                    // åŒ¹é…åæ¸…ç©ºï¼Œé˜²æ­¢æ–‡å­—å †ç§¯
                    // ä¸ºäº†ä¿è¯è¿è´¯æ€§ï¼Œæˆ‘ä»¬åªä¿ç•™æœ€åä¸¤ä¸ªå­—ä½œä¸ºâ€œå°¾å·´â€
                    if (text.length > 10) {
                        e.target.value = text.slice(-2); 
                    }
                }
            });

            // èšç„¦æ—¶æç¤º
            input.addEventListener('focus', function() {
                document.getElementById('status-bar').innerText = "ğŸ¤ è¯·ä½¿ç”¨é”®ç›˜è¯­éŸ³è¾“å…¥...";
                document.getElementById('status-bar').style.color = "#00E5FF";
            });
        }

        // --- æ™ºèƒ½é˜²è·³ (v69) ---
        function smartMatch(transcript) {
            var clean = transcript.replace(/[^\u4e00-\u9fa50-9a-zA-Z]/g, "");
            if (clean.length < 1) return;

            var foundOffset = -1;
            
            if (clean.length >= 2) {
                var key2 = clean.slice(-2);
                var searchWide = 50;
                for (let offset = 0; offset < searchWide; offset++) {
                    if (!words[currIdx + offset] || !words[currIdx + offset + 1]) break;
                    var char1 = words[currIdx + offset].innerText;
                    var char2 = words[currIdx + offset + 1].innerText;
                    if ((char1 + char2) === key2) {
                        foundOffset = offset + 1;
                        break; 
                    }
                }
            }

            if (foundOffset === -1) {
                var key1 = clean.slice(-1);
                var searchNarrow = 8; 
                for (let offset = 0; offset < searchNarrow; offset++) {
                    if (!words[currIdx + offset]) break;
                    if (words[currIdx + offset].innerText === key1) {
                        foundOffset = offset;
                        break; 
                    }
                }
            }

            if (foundOffset !== -1) {
                var newIdx = currIdx + foundOffset;
                for (let i = currIdx; i <= newIdx; i++) {
                     if(words[i]) {
                         words[i].className = (i < newIdx) ? "word passed-word" : "word active-word";
                     }
                }
                currIdx = newIdx;
            }
        }

        // --- æµé€Ÿå¼•æ“ (v69) ---
        function startFlowEngine() {
            function loop() {
                var activeEl = words[currIdx];
                var targetSpeed = 0;

                if (activeEl) {
                    var relativeY = activeEl.getBoundingClientRect().top;
                    var viewportH = window.innerHeight;
                    // v85 ä¿®æ­£ï¼šè€ƒè™‘åˆ°é”®ç›˜å¼¹èµ·ï¼Œè§†å£å˜å°ï¼Œè°ƒæ•´è§¦å‘åŒº
                    // æˆ‘ä»¬å¸Œæœ›å­—åœ¨å±å¹•ä¸Šæ–¹ 1/3 å¤„
                    var ratio = relativeY / viewportH;

                    if (ratio > 0.40) { 
                        targetSpeed = cruiseSpeed + ((ratio - 0.40) * 15); 
                        if(targetSpeed > 15) targetSpeed = 15;
                    } 
                    else if (ratio < 0.20) { 
                        targetSpeed = minSpeed;
                        if (ratio < 0.10) targetSpeed = 0; 
                    } 
                    else { 
                        targetSpeed = cruiseSpeed;
                    }
                }

                currentSpeed += (targetSpeed - currentSpeed) * 0.05;
                container.scrollTop += currentSpeed;
                rafId = requestAnimationFrame(loop);
            }
            loop();
        }

        // UI Helpers
        function changeFontSize(d) {
            var el = document.getElementById('content');
            var s = parseInt(window.getComputedStyle(el).fontSize);
            el.style.fontSize = (s + d) + "px";
        }
        function toggleMirror() { document.getElementById('content').classList.toggle("mirror-on"); }
        function openEditor() { document.getElementById('editor-text').value = rawText; document.getElementById('editor-overlay').style.display = 'flex'; }
        function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
        function saveEditor() { 
            var val = document.getElementById('editor-text').value; 
            if (val) { rawText = val; render(); reset(); closeEditor(); } 
        }
        function reset() { 
            currIdx = 0; render(); container.scrollTop = 0; currentSpeed = minSpeed; 
            document.getElementById('hidden-input').value = "";
        }

        init();
    </script>
</body>
</html>